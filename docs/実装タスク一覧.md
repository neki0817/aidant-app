# AI主導型UI実装タスク一覧

## 実装の目的
「AI主導型UI設計.md」に基づき、ChatGPT/Claude風の対話型UIを持つ小規模事業者持続化補助金申請支援アプリを実装する。

## 前提条件
- React.jsを使用
- Google Maps API統合
- 完全な対話型インターフェース
- 一問一答式の質問フロー
- AI自律エージェント機能による文章補完

---

## Phase 1: 基盤コンポーネントの実装

### 1-1. ChatContainerコンポーネント
**ファイル**: `src/components/chat/ChatContainer.jsx`

**機能要件**:
- 会話全体を管理する最上位コンポーネント
- メッセージ履歴の状態管理
- 現在のフェーズ管理（Phase 0-7）
- プログレス進捗管理
- スクロール制御（新しいメッセージで自動スクロール）

**状態管理**:
```javascript
const [messages, setMessages] = useState([])
const [currentPhase, setCurrentPhase] = useState(0)
const [progress, setProgress] = useState(0)
const [isLoading, setIsLoading] = useState(false)
const [userData, setUserData] = useState({})
```

**実装内容**:
- メッセージ送信ハンドラー
- AI応答生成ロジック呼び出し
- フェーズ遷移制御
- プログレス更新ロジック

---

### 1-2. MessageBubbleコンポーネント
**ファイル**: `src/components/chat/MessageBubble.jsx`

**機能要件**:
- AIメッセージとユーザーメッセージの表示
- メッセージタイプ別のレンダリング
  - `text`: 通常テキスト
  - `question`: 質問（入力欄付き）
  - `analysis`: AI分析結果
  - `preview`: 申請書プレビュー
  - `options`: 選択肢（番号付きリスト）
- タイピングアニメーション
- Markdown対応

**プロップス**:
```javascript
{
  role: 'ai' | 'user',
  type: 'text' | 'question' | 'analysis' | 'preview' | 'options',
  content: string,
  timestamp: Date,
  options?: Array<{id, text}>,
  isTyping?: boolean
}
```

**スタイル要件**:
- AIメッセージ: 左寄せ、薄いグレー背景
- ユーザーメッセージ: 右寄せ、青背景
- アニメーション: フェードイン + スライドアップ
- 最大幅: 70%

---

### 1-3. QuestionInputコンポーネント
**ファイル**: `src/components/chat/QuestionInput.jsx`

**機能要件**:
- 質問タイプに応じた入力フィールド
  - `text`: テキスト入力
  - `number`: 数値入力
  - `select`: セレクトボックス
  - `radio`: ラジオボタン（番号選択式）
  - `textarea`: 複数行テキスト
  - `date`: 日付選択
- バリデーション機能
- 送信ボタン
- Enterキーでの送信対応

**プロップス**:
```javascript
{
  questionType: 'text' | 'number' | 'select' | 'radio' | 'textarea' | 'date',
  placeholder?: string,
  options?: Array<{id, text}>,
  onSubmit: (value) => void,
  disabled?: boolean
}
```

---

### 1-4. ProgressBarコンポーネント
**ファイル**: `src/components/chat/ProgressBar.jsx`

**機能要件**:
- 現在の進捗率を視覚的に表示
- フェーズ名表示
- アニメーション付き進捗バー

**プロップス**:
```javascript
{
  value: number, // 0-100
  phase: string, // "基本情報収集", "売上情報", etc.
  totalSteps: number,
  currentStep: number
}
```

---

## Phase 2: Google Maps API統合

### 2-1. PlaceAutocompleteコンポーネント
**ファイル**: `src/components/maps/PlaceAutocomplete.jsx`

**機能要件**:
- Google Places Autocomplete APIの統合
- 店舗名検索
- サジェスト表示
- 選択時の詳細情報取得

**取得情報**:
- `place_id`: Google Place ID
- `name`: 店舗名
- `formatted_address`: 住所
- `types`: 業種カテゴリ
- `rating`: 評価
- `user_ratings_total`: レビュー数
- `opening_hours`: 営業時間
- `photos`: 写真

---

### 2-2. PlaceDetailsサービス
**ファイル**: `src/services/googleMaps.js`

**機能要件**:
- Place Details API呼び出し
- レビュー取得（最大5件）
- 営業時間の詳細取得
- 写真URL取得
- エラーハンドリング

**関数**:
```javascript
async function getPlaceDetails(placeId)
async function getPlaceReviews(placeId)
async function analyzePlaceData(placeDetails)
```

---

## Phase 3: AI会話フロー制御

### 3-1. conversationalFlowコントローラー
**ファイル**: `src/services/conversationalFlow.js`

**機能要件**:
- Phase 0-7の会話フロー制御
- 質問の動的生成
- 条件分岐ロジック
- 回答バリデーション
- 次の質問の決定

**Phase定義**:
```javascript
Phase 0: AI自己紹介
Phase 1: Google Maps検索・店舗確認
Phase 2: AIによる店舗理解・分析結果表示
Phase 3: 基本情報収集（確実に回答できる質問）
Phase 4: 売上・業績情報
Phase 5: 課題・目標設定
Phase 6: 補助事業計画
Phase 7: 申請書プレビュー・確認
```

**関数**:
```javascript
function getInitialMessage()
function getNextQuestion(currentPhase, userData, previousAnswer)
function validateAnswer(questionId, answer)
function shouldMoveToNextPhase(currentPhase, userData)
function generateAIAnalysis(userData)
```

---

### 3-2. conversationalQuestionsStep1定義
**ファイル**: `src/data/conversationalQuestionsStep1.js`

**機能要件**:
- 一問一答式の質問定義
- 各質問のメタデータ
- 条件分岐ルール
- バリデーションルール

**質問構造**:
```javascript
{
  id: 'Q1-1',
  phase: 1,
  text: '店舗名を教えてください',
  type: 'text',
  required: true,
  dependencies: [],
  conditions: null,
  aiEnhance: false,
  aiContext: '店舗名をGoogle Maps検索に使用'
}
```

---

### 3-3. aiResponseGeneratorサービス
**ファイル**: `src/services/aiResponseGenerator.js`

**機能要件**:
- ユーザー回答に対するAIの自然な応答生成
- 共感表現の追加
- 文脈に応じたフォローアップ
- 分析結果の生成

**関数**:
```javascript
function generateEmpathyResponse(answer, questionContext)
function generateAnalysisMessage(userData, googleMapsData)
function generateTransitionMessage(fromPhase, toPhase)
function generateEncouragementMessage(progress)
```

---

## Phase 4: AI自律エージェント機能

### 4-1. autonomousAgentサービス
**ファイル**: `src/services/autonomousAgent.js`

**機能要件**:
- ユーザー回答の分析
- 追加で必要な情報の判断
- 深堀り質問の自動生成
- 矛盾検出とバリデーション

**関数**:
```javascript
function analyzeUserAnswers(userData)
function identifyMissingInformation(userData, targetSection)
function generateDeepDiveQuestion(context)
function validateConsistency(userData)
```

---

### 4-2. completionTrackerサービス
**ファイル**: `src/services/completionTracker.js`

**機能要件**:
- 情報収集の完成度追跡
- セクション別の充足率計算
- 必須情報のチェック

**評価ポイント**:
1. 企業基本情報（必須）
2. 売上・業績データ（必須）
3. 商品・サービス詳細（必須）
4. 顧客層情報（推奨）
5. 市場動向理解（AI補完可）
6. 競合分析（AI補完可）
7. 強み・弱み（AI補完可）
8. 課題設定（必須）
9. 目標設定（必須）
10. 補助事業計画（必須）
11. 効果測定指標（推奨）

**関数**:
```javascript
function calculateCompletionRate(userData)
function getRequiredQuestions(phase)
function checkSectionCompleteness(section, userData)
```

---

### 4-3. deepDiveEngineサービス
**ファイル**: `src/services/deepDiveEngine.js`

**機能要件**:
- 業種別の深堀り質問データベース
- 文脈に応じた質問選択
- 回答に基づく次の深堀り質問生成

**深堀りパターン**:
```javascript
{
  industry: 'restaurant',
  topic: 'customer_base',
  questions: [
    '主な客層の年齢層は？',
    'リピーター率はどのくらい？',
    '団体客と個人客の比率は？',
    '予約と飛び込みの比率は？'
  ]
}
```

---

### 4-4. validationEngineサービス
**ファイル**: `src/services/validationEngine.js`

**機能要件**:
- 数値の妥当性チェック（従業員数、売上など）
- 日付の整合性チェック
- 業種と回答内容の整合性チェック
- 矛盾検出

**バリデーションルール**:
```javascript
{
  questionId: 'Q2-1',
  rules: [
    {type: 'range', min: 0, max: 10000, message: '売上額が範囲外です'},
    {type: 'consistency', relatedQuestion: 'Q2-2', validator: (a, b) => a < b}
  ]
}
```

---

## Phase 5: 申請書生成機能

### 5-1. documentGeneratorサービス
**ファイル**: `src/services/documentGenerator.js`

**機能要件**:
- 様式2の全セクション生成
- テンプレートエンジン
- 業種別文章パターン適用
- AI補完による文章生成

**生成セクション**:
1. 企業概要
2. 顧客ニーズと市場の動向
3. 自社の強み・弱み
4. 経営方針・目標と今後のプラン
5. 補助事業で行う事業内容
6. 補助事業の効果

**関数**:
```javascript
function generateCompanyOverview(userData, googleMapsData)
function generateMarketAnalysis(userData, industryData)
function generateStrengthsWeaknesses(userData, reviewData)
function generateBusinessPlan(userData)
function generateCompleteDocument(userData)
```

---

### 5-2. templateEngineサービス
**ファイル**: `src/services/templateEngine.js`

**機能要件**:
- 業種別テンプレート管理
- プレースホルダー置換
- 条件分岐処理
- フォーマッティング

**テンプレート例**:
```javascript
{
  section: 'company_overview',
  industry: 'restaurant',
  template: `
    当店は{{founding_year}}年に創業した{{business_type}}です。
    {{location_description}}に位置し、{{target_customer}}をメインターゲットとしています。
    主力商品は{{main_product}}で、{{price_range}}円の価格帯で提供しております。
  `
}
```

---

### 5-3. aiContentEnhancerサービス
**ファイル**: `src/services/aiContentEnhancer.js`

**機能要件**:
- ユーザー入力の文章化
- 専門用語の適切な使用
- 説得力のある表現への変換
- 文字数調整

**関数**:
```javascript
function enhanceUserInput(rawText, context)
function addProfessionalTone(text)
function expandBulletPoints(points)
function summarizeToLength(text, maxLength)
```

---

## Phase 6: プレビュー・編集機能

### 6-1. DocumentPreviewコンポーネント
**ファイル**: `src/components/preview/DocumentPreview.jsx`

**機能要件**:
- 生成された申請書のプレビュー表示
- セクション別表示
- 編集ボタン
- PDFエクスポート準備

---

### 6-2. SectionEditorコンポーネント
**ファイル**: `src/components/preview/SectionEditor.jsx`

**機能要件**:
- セクション単位での編集
- リアルタイムプレビュー
- 文字数カウンター
- 保存・キャンセル

---

## Phase 7: データ永続化

### 7-1. localStorageサービス
**ファイル**: `src/services/localStorage.js`

**機能要件**:
- ユーザーデータの保存
- 会話履歴の保存
- 下書き保存
- データ復元

**関数**:
```javascript
function saveUserData(userData)
function loadUserData()
function saveConversation(messages)
function loadConversation()
function clearAllData()
```

---

### 7-2. Firebaseバックエンド（将来拡張）
**ファイル**: `src/services/firebase.js`

**機能要件**:
- ユーザー認証
- データのクラウド保存
- 複数デバイス間での同期

---

## Phase 8: スタイリング

### 8-1. CSSモジュール
**ファイル**:
- `src/components/chat/ChatContainer.css`
- `src/components/chat/MessageBubble.css`
- `src/components/chat/QuestionInput.css`
- `src/components/chat/ProgressBar.css`

**デザイン要件**:
- モダンなチャットUI
- スムーズなアニメーション
- レスポンシブデザイン
- アクセシビリティ対応

**カラーパレット**:
```css
--ai-message-bg: #f0f0f0
--user-message-bg: #007aff
--accent-color: #007aff
--text-primary: #333333
--text-secondary: #666666
--border-color: #e0e0e0
```

---

## 実装順序の推奨

### 第1週: 基盤構築
1. ChatContainerコンポーネント
2. MessageBubbleコンポーネント
3. QuestionInputコンポーネント
4. ProgressBarコンポーネント
5. 基本的なCSS

### 第2週: 会話フロー
6. conversationalQuestionsStep1データ定義
7. conversationalFlowコントローラー
8. aiResponseGeneratorサービス
9. 会話履歴管理

### 第3週: Google Maps統合
10. PlaceAutocompleteコンポーネント
11. googleMapsサービス
12. 店舗データ分析ロジック

### 第4週: AI自律機能
13. autonomousAgentサービス
14. completionTrackerサービス
15. deepDiveEngineサービス
16. validationEngineサービス

### 第5週: 申請書生成
17. documentGeneratorサービス
18. templateEngineサービス
19. aiContentEnhancerサービス
20. 業種別テンプレート作成

### 第6週: プレビュー・完成
21. DocumentPreviewコンポーネント
22. SectionEditorコンポーネント
23. localStorageサービス
24. 最終調整・バグ修正

---

## テスト項目

### 単体テスト
- [ ] 各コンポーネントのレンダリング
- [ ] 入力バリデーション
- [ ] AI応答生成ロジック
- [ ] データ変換関数

### 統合テスト
- [ ] Phase遷移フロー
- [ ] Google Maps API連携
- [ ] 申請書生成フロー
- [ ] データ保存・復元

### E2Eテスト
- [ ] 最初から最後までの完全フロー
- [ ] 異なる業種での動作確認
- [ ] エラーハンドリング
- [ ] ブラウザ互換性

---

## 必要な外部ライブラリ

```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "@googlemaps/js-api-loader": "^1.16.2",
    "marked": "^9.1.0",
    "date-fns": "^2.30.0"
  },
  "devDependencies": {
    "@testing-library/react": "^14.0.0",
    "@testing-library/jest-dom": "^6.1.0"
  }
}
```

---

## 環境変数設定

**ファイル**: `.env`

```
REACT_APP_GOOGLE_MAPS_API_KEY=your_api_key_here
REACT_APP_FIREBASE_API_KEY=your_firebase_key_here
REACT_APP_FIREBASE_PROJECT_ID=your_project_id_here
```

**注意**: `.env`ファイルは`.gitignore`に追加すること

---

## 完成時の機能チェックリスト

- [ ] AI自己紹介が表示される
- [ ] Google Mapsで店舗検索ができる
- [ ] 店舗情報が自動取得・分析される
- [ ] 一問一答式で質問が進む
- [ ] AI応答が自然で共感的
- [ ] 条件分岐が正しく動作する
- [ ] プログレスバーが更新される
- [ ] 回答バリデーションが機能する
- [ ] 深堀り質問が適切に生成される
- [ ] 申請書が自動生成される
- [ ] プレビューで内容確認ができる
- [ ] セクション単位で編集できる
- [ ] データが保存・復元される
- [ ] レスポンシブデザインが動作する
- [ ] エラー時の適切なフィードバックがある

---

## 備考

- 実装は段階的に行い、各フェーズごとに動作確認を行うこと
- Google Maps APIの利用制限に注意（1日25,000リクエストまで無料）
- AI応答生成は現時点では固定テンプレートとパターンマッチングで実装
- 将来的にはClaude APIやGPT APIを統合する可能性を考慮した設計にする
- ユーザープライバシーに配慮し、機密情報のログ出力は避けること
- アクセシビリティ（キーボード操作、スクリーンリーダー対応）も考慮すること
