# セクション1-3: 立地と商圏（Location and Market Area）

## 対応する様式2のセクション

**様式2「1. 企業概要 > (3) 立地と商圏」**

### 記載内容の要件

1. **店舗の立地**: 最寄り駅からの距離、周辺環境（住宅街/繁華街/オフィス街等）
2. **地域の変化・トレンド**: 再開発、人口動態の変化、新規施設のオープン等
3. **競合の状況**: 同業他社の有無、競合との違い

### 記載例（様式2_サンプル_40代男性.md より）

```
当店は三軒茶屋駅から徒歩5分の住宅街に位置しており、落ち着いた雰囲気の中で食事を楽しめる環境です。近年、駅前の再開発により若いファミリー層が増加しており、当店のターゲット顧客層と合致しています。

近隣には大手チェーン店のカジュアルイタリアンが多いものの、本格的なイタリア料理を提供する店舗は少なく、差別化できています。
```

**文字数**: 約150文字

---

## 既存データの活用

### Q1-0（Google Maps検索）から取得済みのデータ

- **formatted_address**: 完全な住所（例: 東京都世田谷区三軒茶屋2-1-1）
- **address_components**: 都道府県、市区町村、番地等の詳細
- **geometry.location**: 緯度経度

### 活用方法

1. **最寄り駅の自動抽出**: Google Maps Places API の Nearby Search を使用して、店舗の緯度経度から最も近い駅を検索
   - 距離も自動計算（徒歩5分 = 約400m）
   - ただし、ユーザーが修正できるようにする

2. **住所から地域特性の推定**: address_components から市区町村を抽出し、一般的な地域特性を提示
   - 例: 「世田谷区」→ 「住宅街」を推定
   - ユーザーに確認・修正させる

---

## 質問フロー

### Q1-NEW-9: 最寄り駅と距離（自動推定＋確認）

**質問文:**
```
店舗の最寄り駅と距離を確認します。

📍 住所から推定: 三軒茶屋駅から徒歩5分（約400m）

この情報で正しければ「次へ」、修正が必要な場合は正しい駅名と距離を入力してください。

例: 渋谷駅から徒歩10分
```

**入力タイプ**: `text`

**defaultValue**: 自動推定された値（例: "三軒茶屋駅から徒歩5分"）

**処理ロジック:**
```javascript
// ChatContainer.jsx での処理
if (questionId === 'Q1-0') {
  const placeData = answer;

  // 最寄り駅を検索（Cloud Function または Places API Nearby Search）
  const nearestStation = await findNearestStation(
    placeData.geometry.location.lat,
    placeData.geometry.location.lng
  );

  // 距離を計算して徒歩時間に変換（80m/分で計算）
  const distanceM = nearestStation.distance; // メートル
  const walkingMinutes = Math.round(distanceM / 80);

  // 自動推定値を保存
  await saveAnswer('Q1-NEW-9-auto', `${nearestStation.name}から徒歩${walkingMinutes}分`, 0);
}
```

**Cloud Function: findNearestStation**
```javascript
// functions/index.js
exports.findNearestStation = functions
  .region('asia-northeast1')
  .https.onCall(async (data, context) => {
    const { lat, lng } = data;

    // Google Places API Nearby Search
    // type=transit_station で最寄りの駅を検索
    const response = await axios.get(
      'https://maps.googleapis.com/maps/api/place/nearbysearch/json',
      {
        params: {
          location: `${lat},${lng}`,
          rankby: 'distance',
          type: 'transit_station',
          key: functions.config().google.maps_api_key
        }
      }
    );

    const station = response.data.results[0];

    // 距離を計算（Haversine formula）
    const distance = calculateDistance(lat, lng,
      station.geometry.location.lat,
      station.geometry.location.lng
    );

    return {
      name: station.name,
      distance: distance, // メートル
      location: station.geometry.location
    };
  });
```

**バリデーション**: 任意（スキップ可能）

**依存関係**: Q1-0

---

### Q1-NEW-10: 周辺環境の特徴

**質問文:**
```
店舗の周辺環境について教えてください。該当するものを全て選択してください。
```

**入力タイプ**: `multiple_select`

**選択肢:**
```javascript
[
  '住宅街',
  '繁華街・商店街',
  'オフィス街',
  '駅前・駅ビル',
  '観光地',
  '郊外・ロードサイド',
  '商業施設内（ショッピングモール等）',
  'その他'
]
```

**条件分岐:**
- 「その他」を選択した場合 → Q1-NEW-10-other（テキスト入力）

**バリデーション**: 必須（1つ以上選択）

**依存関係**: Q1-NEW-9

---

### Q1-NEW-11: 地域の変化・トレンド

**質問文:**
```
この1-2年で、店舗周辺の地域に変化はありましたか？該当するものを全て選択してください。
```

**入力タイプ**: `multiple_select`

**選択肢:**
```javascript
[
  '再開発があった（駅前、商業施設等）',
  '新しいマンション・住宅が増えた',
  '大型店舗がオープンした',
  '観光客が増えた',
  '人通りが増えた',
  '人通りが減った',
  '競合店が増えた',
  '特に変化はない',
  'その他'
]
```

**条件分岐:**
- 「その他」を選択した場合 → Q1-NEW-11-other（テキスト入力）
- 「特に変化はない」以外を選択 → Q1-NEW-11-detail（詳細説明）

**Q1-NEW-11-detail（条件付き質問）:**
```
選択した変化について、もう少し詳しく教えてください。

例: 駅前に大型商業施設がオープンし、週末の人通りが2倍になった
```

**入力タイプ**: `text`

**placeholder**: "例: 駅前に大型商業施設がオープンし、週末の人通りが2倍になった"

**バリデーション**: 必須（1つ以上選択）

**依存関係**: Q1-NEW-10

---

### Q1-NEW-12: 競合の状況

**質問文:**
```
店舗の周辺に競合となる同業他社はありますか？
```

**入力タイプ**: `single_select`

**選択肢:**
```javascript
[
  'かなり多い（5店舗以上）',
  'ある程度ある（2-4店舗）',
  'ほとんどない（1店舗以下）',
  'わからない'
]
```

**条件分岐:**
- 「かなり多い」「ある程度ある」を選択 → Q1-NEW-12-detail（競合との違い）

**Q1-NEW-12-detail（条件付き質問）:**
```
競合店と比べて、あなたの店舗はどのような点で違いがありますか？

例:
- 大手チェーン店が多いが、当店は本格的な○○を提供している
- 競合は低価格帯だが、当店は高品質・高単価
- 競合は若者向けだが、当店は落ち着いた大人向け
```

**入力タイプ**: `text`

**placeholder**: "例: 大手チェーン店が多いが、当店は本格的なイタリア料理を提供している"

**バリデーション**: 必須

**依存関係**: Q1-NEW-11

---

## 質問完了後の処理

### Q1-SECTION1-3-COMPLETE（自動進行トリガー）

**処理内容:**
```
✅ ありがとうございます！

立地と商圏の情報収集が完了しました。
```

**自動処理:**
- 次のセクション（セクション1-4）へ進む
- **注**: セクション1-3単体では文章生成せず、セクション1-1〜1-4を全て完了後に一括で様式2を生成

---

## データ保存形式

```javascript
answers = {
  // ...既存のQ1-0等
  'Q1-NEW-9': '三軒茶屋駅から徒歩5分',
  'Q1-NEW-9-auto': '三軒茶屋駅から徒歩5分', // 自動推定値
  'Q1-NEW-10': ['住宅街', '駅前・駅ビル'],
  'Q1-NEW-11': ['再開発があった（駅前、商業施設等）', '人通りが増えた'],
  'Q1-NEW-11-detail': '駅前に大型商業施設がオープンし、週末の人通りが2倍になった',
  'Q1-NEW-12': 'ある程度ある（2-4店舗）',
  'Q1-NEW-12-detail': '大手チェーン店のカジュアルイタリアンが多いが、当店は本格的なイタリア料理を提供している'
}
```

---

## 様式2への文章生成（セクション1-1〜1-4完了後）

### 生成ロジック（Cloud Function: generateSection1Draft）

```javascript
// Section 1-3 の部分生成
const generateSection1_3 = (answers) => {
  const station = answers['Q1-NEW-9'];
  const environment = answers['Q1-NEW-10'];
  const trends = answers['Q1-NEW-11'];
  const trendDetail = answers['Q1-NEW-11-detail'];
  const competition = answers['Q1-NEW-12'];
  const competitionDetail = answers['Q1-NEW-12-detail'];

  let text = '';

  // 第1文: 立地と周辺環境
  const envText = environment.join('・');
  text += `当店は${station}の${envText}に位置しており、`;

  // 環境に応じた説明を追加
  if (environment.includes('住宅街')) {
    text += '落ち着いた雰囲気の中で営業している。';
  } else if (environment.includes('繁華街・商店街')) {
    text += '多くの人通りがある立地である。';
  } else if (environment.includes('オフィス街')) {
    text += 'ビジネス客が中心の立地である。';
  }

  // 第2文: 地域の変化・トレンド
  if (trends.length > 0 && !trends.includes('特に変化はない')) {
    text += trendDetail || trends.join('、');
    text += 'といった変化が見られる。';
  }

  // 第3文: 競合の状況
  if (competition !== 'ほとんどない（1店舗以下）') {
    text += competitionDetail || '同業他社が存在するが、差別化を図っている。';
  } else {
    text += '同業他社は少なく、優位性がある。';
  }

  return text;
};
```

### 生成例

**入力データ:**
```javascript
{
  'Q1-NEW-9': '三軒茶屋駅から徒歩5分',
  'Q1-NEW-10': ['住宅街'],
  'Q1-NEW-11': ['再開発があった（駅前、商業施設等）', '人通りが増えた'],
  'Q1-NEW-11-detail': '近年、駅前の再開発により若いファミリー層が増加しており、当店のターゲット顧客層と合致している',
  'Q1-NEW-12': 'ある程度ある（2-4店舗）',
  'Q1-NEW-12-detail': '近隣には大手チェーン店のカジュアルイタリアンが多いものの、本格的なイタリア料理を提供する店舗は少なく、差別化できている'
}
```

**生成される文章:**
```
当店は三軒茶屋駅から徒歩5分の住宅街に位置しており、落ち着いた雰囲気の中で営業している。近年、駅前の再開発により若いファミリー層が増加しており、当店のターゲット顧客層と合致している。近隣には大手チェーン店のカジュアルイタリアンが多いものの、本格的なイタリア料理を提供する店舗は少なく、差別化できている。
```

---

## 質問数とユーザー負担

**基本質問数**: 4問（Q1-NEW-9 〜 Q1-NEW-12）

**条件付き質問**:
- Q1-NEW-10-other: 「その他」選択時のみ（+1問）
- Q1-NEW-11-other: 「その他」選択時のみ（+1問）
- Q1-NEW-11-detail: 地域変化がある場合のみ（+1問）
- Q1-NEW-12-detail: 競合がある場合のみ（+1問）

**最大質問数**: 8問（すべての条件付き質問が発生した場合）

**一般的な質問数**: 5-6問

---

## 実装時の注意事項

1. **最寄り駅の自動推定**:
   - Google Places API の Nearby Search を使用
   - `type=transit_station` で駅のみを検索
   - `rankby=distance` で最も近い駅を取得
   - API制限に注意（1日のリクエスト上限）

2. **距離計算**:
   - Haversine formula で緯度経度から距離を計算
   - 徒歩時間は80m/分で計算（一般的な歩行速度）

3. **ユーザー修正**:
   - 自動推定値はあくまでデフォルト値
   - ユーザーが自由に修正できるようにする

4. **条件分岐の実装**:
   - `condition` 関数で前の質問の回答をチェック
   - 該当しない場合はスキップ

5. **文章生成**:
   - セクション1-3単体では生成せず、セクション1-1〜1-4完了後に一括生成
   - である調（常体）で統一
   - 150文字程度を目安

---

## セクション1全体の進行状況

- ✅ Section 1-1: 事業の概要（16問）
- ✅ Section 1-2: 売上高・利益の推移（7-9問）
- ✅ Section 1-3: 立地と商圏（4-8問）← **今ここ**
- ⏳ Section 1-4: 業務状況と課題（次のセクション）

**合計質問数（予定）**: 約30-35問
