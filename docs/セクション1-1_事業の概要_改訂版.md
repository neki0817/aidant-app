# セクション1-1: 事業の概要（改訂版）

## フロー変更の要点

### 変更前
```
質問16問 → 店舗プロフィール確認・編集 → 自動入力
```

### 変更後
```
質問16問 → AIが「事業の概要」文章を自動生成 → 提示・修正 → 確定
```

---

## 新しいフロー

### Step 1: 質問（16問）
1. Q1-6（法人/個人事業主）
2. Q1-2（法人名と店舗名の違い）（条件付き）
3. Q1-2-company（法人名）（条件付き）
4. Q1-5-corporate（法人設立日）（条件付き）
5. Q1-5（店舗開業日）
6. Q1-0（Google Maps検索）
7. Q1-0-analysis（自動分析）← 業種自動判別
8. Q1-0-website（追加URL）
9. Q1-1（業種確認）← 自動判別結果の確認
10. Q1-3（商品・サービス）
11. Q1-NEW-1（コンセプト）
12. Q1-NEW-2（経営者の経歴）
13. Q1-NEW-3（こだわり）
14. Q1-NEW-4（顧客層）
15. Q1-NEW-5（利用パターン）
16. **Q1-SECTION1-COMPLETE（セクション1-1完了）** ← 新規追加

### Step 2: AI文章生成（自動）
**Q1-SECTION1-DRAFT（事業の概要生成）** ← 新規追加

**表示内容:**
```
✅ ありがとうございます！

これまでの回答をもとに、様式2「事業の概要」の文章を作成します。
少々お待ちください...

🤖 AI が文章を生成中...
```

**処理:**
1. Cloud Function `generateSection1Draft` を呼び出し
2. 16問の回答を元に「事業の概要」を生成
3. である調（常体）で記述
4. 200-400文字程度

### Step 3: 文章の提示・修正
**Q1-SECTION1-REVIEW（事業の概要確認）** ← 新規追加

**表示内容:**
```
📄 様式2「事業の概要」

以下の文章で問題なければ「確定」、修正したい場合は「編集」を押してください。

━━━━━━━━━━━━━━━━━━
当店「トラットリア・ベッラ」は、2019年5月に東京都世田谷区三軒茶屋にて開業したイタリアンレストランです。本格的なイタリア料理を手頃な価格で提供することをコンセプトに、地域のお客様を中心に営業しています。

オーナーシェフである私がイタリア・トスカーナ地方で5年間修行し、現地のリストランテで料理長を務めた経験を活かし、本場の味を再現しています。食材は信頼できるイタリアの生産者から直輸入しており、他店では味わえない本格的な料理を提供している点が特徴です。

主な顧客層は30代〜50代の女性（約6割）、ファミリー層（約3割）で、平日はランチ利用、週末はディナーでのファミリー利用が中心となっています。Google Mapsの口コミ評価は4.3（120件）と、近隣の競合店（平均3.8）と比較して高い評価をいただいています。
━━━━━━━━━━━━━━━━━━

[確定] [編集]
```

**入力タイプ:** draft_review

**選択肢:**
- `confirm`: 「確定」ボタン
- `edit`: 「編集」ボタン

### Step 4-A: 確定の場合
**処理:**
1. 文章をFirestoreに保存
2. 次のセクション（1-2: 売上高・利益の推移）に進む

**表示メッセージ:**
```
✅ 「事業の概要」セクションが完了しました！

次は「売上高・利益の推移」について詳しくお伺いします。
```

### Step 4-B: 編集の場合
**Q1-SECTION1-EDIT（事業の概要編集）** ← 新規追加

**表示内容:**
```
📝 「事業の概要」を編集してください

━━━━━━━━━━━━━━━━━━
[編集可能なテキストエリア]
当店「トラットリア・ベッラ」は、2019年5月に...

━━━━━━━━━━━━━━━━━━

💡 文章を修正したら「保存」を押してください
```

**入力タイプ:** textarea_edit

**maxLength:** 1000文字

**処理:**
1. ユーザーが編集した文章を保存
2. 再度Q1-SECTION1-REVIEWで確認
3. または直接確定して次のセクションへ

---

## 削除する要素

### ❌ Q1-0-profile: 店舗プロフィール確認
- 店舗プロフィール編集UIは不要
- 代わりに、質問終了後に文章を生成

### ❌ StoreProfileEditorコンポーネント
- React コンポーネントは不要
- 代わりに、テキストエリアでの編集機能を使用

---

## 新しい質問定義

### ⓰ Q1-SECTION1-COMPLETE: セクション1-1完了トリガー
**優先度:** 16

**質問文:**
```
ありがとうございます！

これまでの回答をもとに、様式2「事業の概要」の文章を作成します。
少々お待ちください...
```

**入力タイプ:** ai_generation_trigger

**dependencies:** `['Q1-NEW-5']`（最後の質問）

**autoProgress:** true

**aiEnhance:** false

**処理:**
- Cloud Function `generateSection1Draft` を自動呼び出し

---

### ⓱ Q1-SECTION1-DRAFT: 事業の概要生成（自動）
**優先度:** 17

**表示内容:**
```
🤖 AI が「事業の概要」を生成中...

[ローディングアニメーション]

※30秒程度かかる場合があります
```

**入力タイプ:** ai_draft_generation

**dependencies:** `['Q1-SECTION1-COMPLETE']`

**autoProgress:** true

**Cloud Function呼び出し:**
```javascript
const generateSection1Draft = httpsCallable(functions, 'generateSection1Draft');

const result = await generateSection1Draft({
  answers: {
    'Q1-0': placeData,
    'Q1-5': '2019-05-01',
    'Q1-1': 'イタリアンレストラン',
    'Q1-3': 'イタリア料理、ワイン販売',
    'Q1-NEW-1': '本格的なイタリア料理を...',
    'Q1-NEW-2': 'イタリア・トスカーナ地方で...',
    'Q1-NEW-3': '食材は信頼できる...',
    'Q1-NEW-4': '30代〜50代の女性、ファミリー層',
    'Q1-NEW-5': '平日はランチ、週末はディナー',
  }
});

// result.data.draft に生成された文章
```

**生成される文章の構成:**
1. **第1段落**: 開業年月、所在地、業種、コンセプト
2. **第2段落**: 経営者の経歴、専門性、こだわり
3. **第3段落**: 顧客層、利用パターン、評価

**文体:** である調（常体）

**文字数:** 200-400文字

---

### ⓲ Q1-SECTION1-REVIEW: 事業の概要確認
**優先度:** 18

**質問文:**
```
📄 様式2「事業の概要」

以下の文章で問題なければ「確定」、修正したい場合は「編集」を押してください。
```

**入力タイプ:** draft_review

**表示内容:**
```
━━━━━━━━━━━━━━━━━━
{生成された文章}
━━━━━━━━━━━━━━━━━━
```

**選択肢:**
- `confirm`: 「確定」
- `edit`: 「編集」

**dependencies:** `['Q1-SECTION1-DRAFT']`

**helpText:**
```
💡 この文章は申請書に記載されます。内容を確認してください。
```

---

### ⓳ Q1-SECTION1-EDIT: 事業の概要編集（編集選択時のみ）
**優先度:** 19

**条件:** Q1-SECTION1-REVIEWで「編集」を選択した場合のみ

**質問文:**
```
📝 「事業の概要」を編集してください
```

**入力タイプ:** textarea

**defaultValue:** 生成された文章

**maxLength:** 1000文字

**rows:** 10

**dependencies:** `['Q1-SECTION1-REVIEW']`

**condition:**
```javascript
(answers) => answers['Q1-SECTION1-REVIEW'] === 'edit'
```

**helpText:**
```
💡 文章を修正したら「保存」を押してください。保存後、再度確認画面が表示されます。
```

**処理:**
1. 編集後の文章を保存
2. Q1-SECTION1-REVIEWに戻る（編集後の文章で再表示）
3. または「確定」ボタンで直接次へ

---

## Cloud Function: generateSection1Draft

### 入力パラメータ
```typescript
interface GenerateSection1DraftRequest {
  answers: {
    'Q1-0': PlaceData;           // Google Maps情報
    'Q1-5-corporate'?: string;   // 法人設立日（法人の場合のみ）
    'Q1-5': string;              // 開業日
    'Q1-1': string;              // 業種
    'Q1-3': string;              // 商品・サービス
    'Q1-NEW-1': string;          // コンセプト
    'Q1-NEW-2': string;          // 経営者の経歴
    'Q1-NEW-3': string;          // こだわり
    'Q1-NEW-4': string;          // 顧客層
    'Q1-NEW-5': string;          // 利用パターン
    'Q1-2-company'?: string;     // 法人名（該当する場合）
  };
  userProfile?: {
    age?: number;
    gender?: string;
  };
}
```

### 出力
```typescript
interface GenerateSection1DraftResponse {
  draft: string;                 // 生成された文章
  pointsUsed: number;            // 使用ポイント（20ポイント）
  remainingPoints: number;       // 残りポイント
}
```

### プロンプト例
```
あなたは小規模事業者持続化補助金の申請書作成の専門家です。

以下の情報をもとに、様式2「1. 企業概要 > (1) 事業の概要」の文章を作成してください。

【条件】
- 文体: である調（常体）
- 文字数: 200-400文字
- 構成: 3段落
  - 第1段落: 開業年月、所在地、業種、コンセプト
  - 第2段落: 経営者の経歴、専門性、こだわり
  - 第3段落: 顧客層、利用パターン、評価

【入力情報】
- 店舗名: トラットリア・ベッラ
- 所在地: 東京都世田谷区三軒茶屋
- 開業日: 2019年5月
- 業種: イタリアンレストラン
- 商品・サービス: イタリア料理、ワイン販売
- コンセプト: 本格的なイタリア料理を手頃な価格で提供することをコンセプトに、地域のお客様を中心に営業
- 経営者の経歴: イタリア・トスカーナ地方で5年間修行し、現地のリストランテで料理長を務めた経験
- こだわり: 食材は信頼できるイタリアの生産者から直輸入しており、他店では味わえない本格的な料理を提供
- 顧客層: 30代〜50代の女性（約6割）、ファミリー層（約3割）
- 利用パターン: 平日はランチ利用、週末はディナーでのファミリー利用が中心
- Google口コミ: 4.3（120件）

【サンプル】
当店「トラットリア・ベッラ」は、2019年5月に東京都世田谷区三軒茶屋にて開業したイタリアンレストランです。本格的なイタリア料理を手頃な価格で提供することをコンセプトに、地域のお客様を中心に営業しています。

オーナーシェフである私がイタリア・トスカーナ地方で5年間修行し、現地のリストランテで料理長を務めた経験を活かし、本場の味を再現しています。食材は信頼できるイタリアの生産者から直輸入しており、他店では味わえない本格的な料理を提供している点が特徴です。

主な顧客層は30代〜50代の女性（約6割）、ファミリー層（約3割）で、平日はランチ利用、週末はディナーでのファミリー利用が中心となっています。Google Mapsの口コミ評価は4.3（120件）と、近隣の競合店（平均3.8）と比較して高い評価をいただいています。

上記のサンプルを参考に、入力情報をもとに文章を作成してください。
```

### 実装例（functions/index.js）
```javascript
exports.generateSection1Draft = functions
  .region('asia-northeast1')
  .https.onCall(async (data, context) => {
    // 認証チェック
    if (!context.auth) {
      throw new functions.https.HttpsError('unauthenticated', 'ログインが必要です');
    }

    const { answers, userProfile } = data;
    const userId = context.auth.uid;

    // ポイント消費（20ポイント）
    const COST = 20;
    const userDoc = await admin.firestore().collection('users').doc(userId).get();
    const currentPoints = userDoc.data()?.points || 0;

    if (currentPoints < COST) {
      throw new functions.https.HttpsError('resource-exhausted', 'ポイントが不足しています');
    }

    // OpenAI呼び出し
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: 'あなたは小規模事業者持続化補助金の申請書作成の専門家です。'
        },
        {
          role: 'user',
          content: generatePrompt(answers)
        }
      ],
      temperature: 0.7,
      max_tokens: 800
    });

    const draft = completion.choices[0].message.content;

    // ポイント消費
    await admin.firestore().collection('users').doc(userId).update({
      points: admin.firestore.FieldValue.increment(-COST)
    });

    return {
      draft,
      pointsUsed: COST,
      remainingPoints: currentPoints - COST
    };
  });
```

---

## UI実装（React）

### ChatContainer.jsxの変更点

#### 1. Q1-SECTION1-DRAFTの処理
```javascript
// Q1-SECTION1-COMPLETE後、自動でCloud Function呼び出し
if (questionId === 'Q1-SECTION1-COMPLETE') {
  setIsLoading(true);

  try {
    const functions = getFunctions(undefined, 'asia-northeast1');
    const generateSection1Draft = httpsCallable(functions, 'generateSection1Draft');

    const result = await generateSection1Draft({ answers });

    // 生成された文章を保存
    await saveAnswer('Q1-SECTION1-DRAFT', result.data.draft, result.data.pointsUsed);

    // 次の質問（Q1-SECTION1-REVIEW）を表示
    const nextQuestion = getCurrentQuestion();
    setCurrentQuestion(nextQuestion);

  } catch (error) {
    console.error('Draft generation error:', error);
    addAIMessage('文章の生成に失敗しました。もう一度お試しください。');
  } finally {
    setIsLoading(false);
  }

  return;
}
```

#### 2. Q1-SECTION1-REVIEWの表示
```javascript
// draft_review タイプの質問の場合
{currentQuestion?.type === 'draft_review' && (
  <DraftReviewComponent
    draft={answers['Q1-SECTION1-DRAFT']}
    onConfirm={() => handleAnswer('Q1-SECTION1-REVIEW', 'confirm')}
    onEdit={() => handleAnswer('Q1-SECTION1-REVIEW', 'edit')}
  />
)}
```

#### 3. DraftReviewComponent（新規作成）
```javascript
const DraftReviewComponent = ({ draft, onConfirm, onEdit }) => {
  return (
    <div className="draft-review">
      <h3>📄 様式2「事業の概要」</h3>
      <p className="review-instruction">
        以下の文章で問題なければ「確定」、修正したい場合は「編集」を押してください。
      </p>

      <div className="draft-content">
        {draft}
      </div>

      <div className="draft-actions">
        <button onClick={onEdit} className="btn-secondary">
          ✏️ 編集
        </button>
        <button onClick={onConfirm} className="btn-primary">
          ✅ 確定
        </button>
      </div>

      <p className="help-text">
        💡 この文章は申請書に記載されます。内容を確認してください。
      </p>
    </div>
  );
};
```

#### 4. Q1-SECTION1-EDITの表示
```javascript
// textarea_edit タイプの質問の場合
{currentQuestion?.type === 'textarea_edit' && (
  <TextareaEditComponent
    defaultValue={answers['Q1-SECTION1-DRAFT']}
    onSave={(editedText) => handleAnswer('Q1-SECTION1-EDIT', editedText)}
    onCancel={handleGoBack}
  />
)}
```

---

## データ構造（Firestore）

### applications/{applicationId}/answers/{answerId}
```javascript
{
  // 質問の回答
  'Q1-0': { /* Google Mapsデータ */ },
  'Q1-5': '2019-05-01',
  'Q1-1': 'イタリアンレストラン',
  'Q1-3': 'イタリア料理、ワイン販売',
  'Q1-NEW-1': '本格的なイタリア料理を...',
  'Q1-NEW-2': 'イタリア・トスカーナ地方で...',
  'Q1-NEW-3': '食材は信頼できる...',
  'Q1-NEW-4': '30代〜50代の女性、ファミリー層',
  'Q1-NEW-5': '平日はランチ、週末はディナー',

  // 生成された文章
  'Q1-SECTION1-DRAFT': '当店「トラットリア・ベッラ」は...',

  // レビュー結果
  'Q1-SECTION1-REVIEW': 'confirm', // or 'edit'

  // 編集後の文章（編集した場合のみ）
  'Q1-SECTION1-EDIT': '当店「トラットリア・ベッラ」は...（編集版）'
}
```

### applications/{applicationId}/form2Sections/section1-1
```javascript
{
  title: '事業の概要',
  content: '当店「トラットリア・ベッラ」は...',
  isEdited: false, // または true
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

---

## まとめ

### 変更点
1. ❌ **店舗プロフィール確認UI削除**
2. ✅ **16問の質問終了後にAI文章生成**
3. ✅ **生成された文章を提示・編集・確定フロー**

### メリット
1. **シンプルなUX**: プロフィール編集→文章生成ではなく、直接文章を確認
2. **申請書イメージの可視化**: 実際の申請書の文章が見える
3. **編集の自由度**: テキストエリアで自由に編集可能

### ポイント消費
- **Q1-SECTION1-DRAFT生成**: 20ポイント

### 次のステップ
セクション1-2（売上高・利益の推移）も同じフローで設計しますか？
