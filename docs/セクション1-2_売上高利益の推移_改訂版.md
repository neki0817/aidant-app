# セクション1-2: 事業別売上高・利益の推移（改訂版）

## 取得済み情報の活用

### Google Mapsから自動取得
1. ✅ **営業時間・定休日** → 営業日数を推定
2. ✅ **口コミ評価** → セクション1-1で使用

### Q1-0-profile（店舗プロフィール）から取得
1. ✅ **estimatedPrice（推定客単価）** → Q1-11の初期値として使用

### 自動計算
1. ✅ **月間売上** = 年間売上 ÷ 12
2. ✅ **経常利益率** = 経常利益 ÷ 年間売上 × 100

---

## 質問順序（改訂版）

1. **Q1-8（年間売上高）**
   - 回答後 → 月間売上を自動計算して表示

2. **Q1-8-trend（売上の傾向）**

3. **Q1-9（経常利益）**
   - 回答後 → 経常利益率を自動計算して表示

4. **Q1-10（粗利率）**

5. **Q1-11（客単価）**
   - **初期値:** Q1-0-profileのestimatedPrice
   - ユーザー確認・修正

6. **Q1-NEW-6（客単価の内訳）**（条件付き）

7. **Q1-NEW-7（営業日数）**
   - **初期値:** Google Mapsから推定
   - ユーザー確認・修正

8. **Q1-NEW-8（粗利の理由）**（条件付き）

9. **Q1-SECTION1-2-COMPLETE** → AI文章生成

---

## 詳細な質問設計（改訂版）

### ❶ Q1-8: 年間売上高
**優先度:** 20

**質問文:**
```
直近の決算期（または確定申告）の年間売上を教えてください

わからない場合は概算で構いません
```

**入力タイプ:** number

**placeholder:** 「例：1440」

**unit:** 「万円」

**dependencies:** `['Q1-NEW-5']`（セクション1-1完了後）

**required:** true

**helpText:**
```
💡 直近1年間の売上高を入力してください。個人事業主の方は確定申告書の「売上」欄を参照してください。
```

**回答後の自動計算・表示:**
```javascript
if (questionId === 'Q1-8') {
  const annualRevenue = answer;
  const monthlyRevenue = Math.round(annualRevenue / 12);

  await saveAnswer(questionId, answer, 0);

  // 自動計算結果を表示
  addAIMessage(`✅ 年間売上: ${annualRevenue}万円\n📊 月間売上（平均）: 約${monthlyRevenue}万円`);

  // 次の質問へ
  const nextQuestion = getCurrentQuestion();
  setCurrentQuestion(nextQuestion);
  addAIMessage(nextQuestion.text, nextQuestion);
}
```

**Firestoreに保存:**
```javascript
{
  'Q1-8': 1440,
  'Q1-8-monthly': 120  // 自動計算結果も保存
}
```

**様式2への反映:**
- 「直近期の月間売上は平均120万円、年間売上は1,440万円となっています」

---

### ❷ Q1-8-trend: 売上の傾向
**優先度:** 21

**質問文:**
```
ここ数年の売上の傾向を教えてください

1. 上昇している
2. 横ばい
3. 下降している
4. わからない
```

**入力タイプ:** single_select

**選択肢:**
- `increasing`: 「上昇している」
- `flat`: 「横ばい」
- `decreasing`: 「下降している」
- `unknown`: 「わからない」

**dependencies:** `['Q1-8']`

**required:** true

**helpText:**
```
💡 過去2-3年と比較して、売上が増えているか、減っているかを教えてください
```

**様式2への反映:**
- 「開業から順調に売上・利益ともに成長しており」（上昇の場合）

---

### ❸ Q1-9: 経常利益
**優先度:** 22

**質問文:**
```
直近の決算期（または確定申告）の経常利益（または営業利益）を教えてください

わからない場合は「0」と入力してください
```

**入力タイプ:** number

**placeholder:** 「例：150」

**unit:** 「万円」

**dependencies:** `['Q1-8-trend']`

**required:** true

**allowNegative:** true

**helpText:**
```
💡 法人の場合は「経常利益」、個人事業主の場合は「所得金額」を入力してください。赤字の場合はマイナスで入力してください。
```

**回答後の自動計算・表示:**
```javascript
if (questionId === 'Q1-9') {
  const profit = answer;
  const revenue = answers['Q1-8'];
  const profitRate = ((profit / revenue) * 100).toFixed(1);

  await saveAnswer(questionId, answer, 0);

  // 自動計算結果を表示
  addAIMessage(`✅ 経常利益: ${profit}万円\n📊 経常利益率: ${profitRate}%`);

  // 赤字の場合は補足メッセージ
  if (profit < 0) {
    addAIMessage(`💡 赤字の場合は、補助金の補助率が3/4（通常は2/3）に優遇されます`);
  }

  // 次の質問へ
  const nextQuestion = getCurrentQuestion();
  setCurrentQuestion(nextQuestion);
  addAIMessage(nextQuestion.text, nextQuestion);
}
```

**Firestoreに保存:**
```javascript
{
  'Q1-9': 150,
  'Q1-9-rate': 10.4  // 自動計算結果も保存
}
```

**様式2への反映:**
- 「経常利益: 150万円」
- 「経常利益率: 10.4%」

---

### ❹ Q1-10: 粗利率
**優先度:** 23

**質問文:**
```
おおよその粗利益率（売上総利益率）を教えてください

わからない場合は業種の平均値を入力してください
```

**入力タイプ:** number

**placeholder（動的生成）:**
```javascript
(answers) => {
  const businessType = answers['Q1-1'];
  const industryAverage = getIndustryAverageProfitMargin(businessType);
  return `例：${industryAverage}（${businessType}の平均）`;
}
```

**unit:** 「%」

**min:** 0
**max:** 100

**dependencies:** `['Q1-9']`

**required:** true

**helpText:**
```
💡 粗利率 = (売上 - 原価) ÷ 売上 × 100
飲食業: 約60%、小売業: 約30-40%、サービス業: 約70-80%
```

**業種別の平均値（参考表示）:**
```javascript
const industryAverages = {
  'レストラン': 60,
  'イタリアンレストラン': 60,
  'カフェ': 65,
  '美容室': 75,
  'エステ': 80,
  'アパレル': 35,
  '小売店': 40,
  'パン屋': 55,
  // ...
};

const getIndustryAverageProfitMargin = (businessType) => {
  // 完全一致
  if (industryAverages[businessType]) {
    return industryAverages[businessType];
  }

  // 部分一致
  for (const [type, avg] of Object.entries(industryAverages)) {
    if (businessType.includes(type)) {
      return avg;
    }
  }

  // デフォルト
  return 50;
};
```

**様式2への反映:**
- 「売上総利益率（粗利率）は約65%で、飲食業の平均（60%）を上回る水準を維持しています」

---

### ❺ Q1-11: 客単価
**優先度:** 24

**質問文（動的生成）:**
```javascript
(answers) => {
  const profile = answers['Q1-0-profile'];
  const estimatedPrice = profile?.estimatedPrice;

  if (estimatedPrice) {
    return `お客様1人あたりの平均的な購入金額（客単価）を教えてください\n\nGoogle Maps等から推定: 約${estimatedPrice}円\n\n修正が必要な場合は正しい金額を入力してください。そのままで良い場合は「次へ」を押してください。`;
  } else {
    return 'お客様1人あたりの平均的な購入金額（客単価）を教えてください';
  }
}
```

**入力タイプ:** number

**placeholder:** 「例：5000」

**unit:** 「円」

**dependencies:** `['Q1-10']`

**required:** true

**defaultValue（動的生成）:**
```javascript
(answers) => {
  const profile = answers['Q1-0-profile'];
  return profile?.estimatedPrice || '';
}
```

**helpText:**
```
💡 1回の来店・購入で、お客様が支払う平均金額を入力してください
```

**様式2への反映:**
- 「客単価は約5,000円」

---

### ❻ Q1-NEW-6: 客単価の内訳（条件付き）
**優先度:** 25

**条件:** 業種が飲食・サービス業、かつ時間帯・メニューによって単価が異なる場合

**質問文:**
```
客単価の内訳があれば教えてください

例:
- 「ランチ3,500円、ディナー6,500円」
- 「カット5,000円、カラー8,000円」
- 「平日3,000円、週末4,000円」

わからない場合、または内訳がない場合は「なし」と入力してください
```

**入力タイプ:** text

**placeholder:** 「例：ランチ3,500円、ディナー6,500円」

**dependencies:** `['Q1-11']`

**required:** false

**maxLength:** 100文字

**condition:**
```javascript
(answers) => {
  const businessType = answers['Q1-1'];
  // 飲食・サービス業の場合のみ表示
  return ['レストラン', 'カフェ', 'バー', '美容室', 'エステ', 'ネイル'].some(type =>
    businessType.includes(type)
  );
}
```

**helpText:**
```
💡 時間帯やメニューによって単価が異なる場合は、内訳を教えてください
```

**様式2への反映:**
- 「客単価は約5,000円（ランチ3,500円、ディナー6,500円の加重平均）」

---

### ❼ Q1-NEW-7: 営業日数
**優先度:** 26

**質問文（動的生成）:**
```javascript
(answers) => {
  const placeData = answers['Q1-0'];
  const estimatedDays = estimateOperatingDaysFromGoogleMaps(placeData?.openingHours);

  if (estimatedDays) {
    return `週に何日営業していますか？\n\nGoogle Mapsから推定: ${getDaysLabel(estimatedDays)}\n\n修正が必要な場合は正しい営業日数を選択してください。そのままで良い場合は「次へ」を押してください。`;
  } else {
    return '週に何日営業していますか？';
  }
}
```

**入力タイプ:** single_select

**選択肢:**
- `7`: 「毎日（7日）」
- `6`: 「週6日」
- `5`: 「週5日」
- `4`: 「週4日以下」

**dependencies:** `['Q1-11']`（Q1-NEW-6はスキップされる可能性があるため）

**required:** true

**defaultValue（動的生成）:**
```javascript
(answers) => {
  const placeData = answers['Q1-0'];
  return estimateOperatingDaysFromGoogleMaps(placeData?.openingHours);
}
```

**helpText:**
```
💡 通常営業している日数を教えてください（臨時休業は除く）
```

**Google Mapsからの推定ロジック:**
```javascript
const estimateOperatingDaysFromGoogleMaps = (openingHours) => {
  if (!openingHours?.weekday_text) return null;

  let operatingDays = 0;
  for (const dayText of openingHours.weekday_text) {
    // 「定休日」「Closed」が含まれていない = 営業日
    if (!dayText.includes('定休日') && !dayText.includes('Closed') && !dayText.includes('closed')) {
      operatingDays++;
    }
  }

  if (operatingDays === 7) return '7';
  if (operatingDays === 6) return '6';
  if (operatingDays === 5) return '5';
  if (operatingDays <= 4) return '4';

  return null;
};

const getDaysLabel = (days) => {
  const labels = {
    '7': '毎日（7日）',
    '6': '週6日',
    '5': '週5日',
    '4': '週4日以下'
  };
  return labels[days] || days;
};
```

**様式2への反映:**
- 「週6日営業（月曜定休）しています」

---

### ❽ Q1-NEW-8: 粗利が高い/低い理由（条件付き）
**優先度:** 27

**条件:** 粗利率が業界平均より±10%以上異なる場合のみ表示

**質問文（動的生成）:**
```javascript
(answers) => {
  const profitMargin = answers['Q1-10'];
  const businessType = answers['Q1-1'];
  const industryAverage = getIndustryAverageProfitMargin(businessType);
  const diff = profitMargin - industryAverage;

  if (diff >= 10) {
    return `粗利率が${industryAverage}%（${businessType}の平均）に対して${profitMargin}%と高いですが、理由がわかれば教えてください\n\n例:\n- 「直輸入により中間マージンを削減」\n- 「自家製パスタなど付加価値の高い商品を提供」\n\nわからない場合は「わからない」と入力してください`;
  } else if (diff <= -10) {
    return `粗利率が${industryAverage}%（${businessType}の平均）に対して${profitMargin}%と低いですが、理由がわかれば教えてください\n\n例:\n- 「高品質な原材料を使用」\n- 「競合が多く価格競争が激しい」\n\nわからない場合は「わからない」と入力してください`;
  }
}
```

**入力タイプ:** textarea

**placeholder:**
```
例：イタリアからの直輸入により中間マージンを削減できていることと、自家製パスタなど付加価値の高い商品を提供していることが要因です
```

**dependencies:** `['Q1-10', 'Q1-NEW-7']`

**required:** false

**maxLength:** 200文字

**condition:**
```javascript
(answers) => {
  const profitMargin = answers['Q1-10'];
  const businessType = answers['Q1-1'];
  const industryAverage = getIndustryAverageProfitMargin(businessType);
  return Math.abs(profitMargin - industryAverage) >= 10;
}
```

**helpText:**
```
💡 粗利率が高い（または低い）理由を具体的に教えてください
```

**様式2への反映:**
- 「これはイタリアからの直輸入により中間マージンを削減できていることと、自家製パスタなど付加価値の高い商品を提供していることが要因です」

---

### ❾ Q1-SECTION1-2-COMPLETE: セクション1-2完了トリガー
**優先度:** 28

**質問文:**
```
ありがとうございます！

これまでの回答をもとに、様式2「売上高・利益の推移」の文章を作成します。
少々お待ちください...
```

**入力タイプ:** ai_generation_trigger

**dependencies:** `['Q1-NEW-7']`（Q1-NEW-8は条件付きなので依存しない）

**autoProgress:** true

**処理:**
- Cloud Function `generateSection1_2Draft` を自動呼び出し

---

## AI文章生成（Cloud Function）

### generateSection1_2Draft

**入力パラメータ:**
```javascript
{
  answers: {
    'Q1-8': 1440,           // 年間売上
    'Q1-8-monthly': 120,    // 月間売上（自動計算）
    'Q1-8-trend': 'increasing',  // 売上傾向
    'Q1-9': 150,            // 経常利益
    'Q1-9-rate': 10.4,      // 経常利益率（自動計算）
    'Q1-10': 65,            // 粗利率
    'Q1-11': 5000,          // 客単価
    'Q1-NEW-6': 'ランチ3,500円、ディナー6,500円',  // 客単価内訳
    'Q1-NEW-7': '6',        // 営業日数
    'Q1-NEW-8': 'イタリアからの直輸入により...',  // 粗利の理由
    'Q1-1': 'イタリアンレストラン',  // 業種（業界平均参照用）
  }
}
```

**プロンプト:**
```
あなたは小規模事業者持続化補助金の申請書作成の専門家です。

以下の情報をもとに、様式2「1. 企業概要 > (2) 事業別売上高・利益の推移」の文章を作成してください。

【条件】
- 文体: である調（常体）
- 文字数: 200-300文字
- 構成: 2段落
  - 第1段落: 売上・利益の推移、月間売上、客単価、営業日数
  - 第2段落: 粗利率、業界平均との比較、理由（ある場合）

【入力情報】
- 年間売上: 1,440万円
- 月間売上: 120万円
- 売上傾向: 上昇している
- 経常利益: 150万円
- 経常利益率: 10.4%
- 粗利率: 65%
- 業種: イタリアンレストラン
- 業界平均粗利率: 60%
- 客単価: 5,000円
- 客単価内訳: ランチ3,500円、ディナー6,500円
- 営業日数: 週6日
- 粗利が高い理由: イタリアからの直輸入により中間マージンを削減できていることと、自家製パスタなど付加価値の高い商品を提供していること

【サンプル】
開業から順調に売上・利益ともに成長しており、直近期の月間売上は平均120万円、年間売上は1,440万円となっています。客単価は約5,000円（ランチ3,500円、ディナー6,500円の加重平均）で、週6日営業（月曜定休）しています。

売上総利益率（粗利率）は約65%で、飲食業の平均（60%）を上回る水準を維持しています。これはイタリアからの直輸入により中間マージンを削減できていることと、自家製パスタなど付加価値の高い商品を提供していることが要因です。
```

**出力:**
```javascript
{
  draft: "開業から順調に売上・利益ともに成長しており...",
  pointsUsed: 15,
  remainingPoints: 485
}
```

---

## まとめ

### 取得済み情報の活用（改訂版）

1. ✅ **推定客単価** → Q1-11の初期値
2. ✅ **営業日数** → Q1-NEW-7の初期値（Google Mapsから推定）
3. ✅ **月間売上** → Q1-8から自動計算
4. ✅ **経常利益率** → Q1-9から自動計算

### 質問数
- **既存質問:** 5問（Q1-8, Q1-8-trend, Q1-9, Q1-10, Q1-11）
- **新規質問:** 3問（Q1-NEW-6, Q1-NEW-7, Q1-NEW-8）
- **条件付き:** 2問（Q1-NEW-6, Q1-NEW-8）
- **合計:** 最大8問（条件により6-8問）

### ユーザー体験の改善
1. **自動推定値の提示** → 修正不要なら「次へ」で進める
2. **自動計算結果の即時表示** → 月間売上、経常利益率を自動計算
3. **業界平均との比較** → 粗利率が特異な場合のみ理由を質問

### 様式2への反映度
**100%完成**
