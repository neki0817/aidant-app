# 様式2生成ロジック修正完了レポート

## 修正日時
2025年10月23日

## 修正内容

`buildApplicationPrompt`関数を完全に書き直し、Phase 1-5の全データを活用した高品質な様式2を生成できるようにしました。

---

## 1. 修正したファイル

### `src/services/gemini/gemini.js`

**修正箇所:** 53-374行目（`buildApplicationPrompt`関数全体）

---

## 2. 修正前の問題点

### 問題1: 古い質問IDを参照
```javascript
// 修正前
const storeInfo = answers['Q2-0'] || {};  // ← 存在しない
const businessGoals = answers['Q1-2'] || [];  // ← 存在しない
const initiatives = answers['Q1-3'] || [];  // ← 存在しない
```

**結果:** ほとんどのデータが空欄となり、低品質な申請書が生成される

### 問題2: Phase 2-5のデータを使っていない

収集した貴重な情報（顧客分析、強み、経営方針など）が全く活用されていませんでした。

### 問題3: CLAUDE.mdの様式2要件と不一致

様式2の構成や記載内容がCLAUDE.mdの要件と異なっていました。

---

## 3. 修正後の実装

### 3.1 Phase 1-5の全データを取得

```javascript
// ===== Phase 1: 基本情報 =====
const placeInfo = answers['Q1-0'] || {};
const businessType = answers['Q1-1'] || '';
const representative = answers['Q1-2'] || '';
// ... Q1-21まで全て取得

// ===== Phase 2: 顧客ニーズと市場の動向 =====
const targetCustomer = answers['P2-1'] || '';
const whyChosen = answers['P2-2'] || '';
// ... P2-6まで全て取得

// ===== Phase 3: 自社の強み =====
const uniqueness = answers['P3-1'] || '';
const customerValue = answers['P3-2'] || '';
// ... P3-7まで全て取得

// ===== Phase 4: 経営方針・目標 =====
const futureGoals = answers['P4-1'] || '';
const goalPlan = answers['P4-2'] || '';
// ... P4-8まで全て取得

// ===== Phase 5: 補助事業の内容 =====
const subsidyUsage = answers['P5-1'] || '';
const plannedEquipment = answers['P5-2'] || '';
// ... P5-12まで全て取得
```

**対応質問数:**
- Phase 1: 21質問（Q1-0 〜 Q1-21）
- Phase 2: 6質問（P2-1 〜 P2-6）
- Phase 3: 7質問（P3-1 〜 P3-7）
- Phase 4: 8質問（P4-1 〜 P4-8）
- Phase 5: 12質問（P5-1 〜 P5-12）

**合計: 54質問すべてのデータを活用**

### 3.2 プロンプト構成の改善

修正後のプロンプトは、Gemini APIに以下の情報を詳細に提供します：

#### Phase 1データの提供
```
# 【Phase 1】 基本情報

## 事業者情報
- 店舗名：${placeInfo.name || ''}
- 住所：${placeInfo.address || ''}
- 業種：${businessType}
... (全項目)

## 財務データ（過去3期分）
- 直近期の年間売上：${latestSales}万円
- 直近期の経常利益：${latestProfit}万円
... (全項目)
```

#### Phase 2-5データの提供
同様に、Phase 2-5の全回答データを構造化してGeminiに提供

### 3.3 様式2の出力フォーマット指定

CLAUDE.mdの要件に完全準拠した出力フォーマットを指定：

```
## 【経営計画】

### 1. 企業概要（800-1200文字）

**記載内容:**
- 事業の概要（創業年、主要サービス、顧客層）
- 過去3期分の売上高・経常利益の推移（表形式）
- 立地場所の特性
... (詳細な指示)

**文体:** である調（常体）

### 2. 顧客ニーズと市場の動向（800-1200文字）
... (同様の詳細な指示)

### 3. 自社や自社の提供する商品・サービスの強み（800-1200文字）
... (同様の詳細な指示)

### 4. 経営方針・目標と今後のプラン（800-1200文字）
... (同様の詳細な指示)

## 【補助事業計画】

### 1. 補助事業で行う事業名（30文字以内）

### 2. 販路開拓等（生産性向上）の取組内容（1200-1800文字）
... (詳細な指示)

### 3. 補助事業の効果（800-1200文字）
... (詳細な指示)
```

### 3.4 文体の統一指示

```
# 【重要な注意事項】

1. **文体を統一すること**
   - 必ず「である調（常体）」を使用
   - 「〜である」「〜だ」「〜する」等の語尾
   - 「です・ます調」は絶対に使用しない
```

**これにより、CLAUDE.mdの要件「文体: である調（常体）」に確実に準拠**

### 3.5 必須要素の明示

```
3. **必ず含めるべき要素**
   - 過去3期分の売上・利益の推移（表形式）
   - 具体的な数値データ（客単価、粗利率、顧客数等）
   - Google Maps評価や口コミの引用
   - 課題と解決策のセット
   - 補助事業の効果の具体的な計算根拠
```

---

## 4. 修正後の生成フロー

```
ユーザーがPhase 1-5の質問に回答
    ↓
全回答データをFirestoreに保存
    ↓
「申請書を生成」ボタンを押す
    ↓
ApplicationContext.generateApplication()呼び出し
    ↓
gemini.js の generateSubsidyApplication(answers) 呼び出し
    ↓
buildApplicationPrompt(answers) が呼ばれる
    ↓
Phase 1-5の全54質問のデータを取得
    ↓
CLAUDE.md準拠の詳細なプロンプトを構築
    ↓
Gemini API (gemini-2.5-flash) に送信
    ↓
様式2（経営計画書兼補助事業計画書）が生成される
    ↓
マークダウン形式で返却
    ↓
UIに表示・ダウンロード可能
```

---

## 5. 生成される様式2の構成

### 【経営計画】セクション

1. **企業概要（800-1200文字）**
   - Phase 1のデータを活用
   - 過去3期分の売上・利益の表
   - 立地、従業員数、業務状況

2. **顧客ニーズと市場の動向（800-1200文字）**
   - Phase 2のデータを活用
   - ターゲット顧客層の分析
   - 市場トレンド、競合比較

3. **自社や自社の提供する商品・サービスの強み（800-1200文字）**
   - Phase 3のデータを活用
   - 独自性・差別化ポイント（箇条書き●）
   - Google Maps評価の引用
   - 課題・弱みの記載

4. **経営方針・目標と今後のプラン（800-1200文字）**
   - Phase 4のデータを活用
   - 現状の課題認識
   - 数値目標（売上、顧客数等）
   - 具体的な行動計画

### 【補助事業計画】セクション

1. **補助事業で行う事業名（30文字以内）**
   - Phase 5のデータから自動生成

2. **販路開拓等（生産性向上）の取組内容（1200-1800文字）**
   - Phase 5のデータを活用
   - 実施する施策の詳細
   - 創意工夫のポイント

3. **補助事業の効果（800-1200文字）**
   - Phase 5のデータを活用
   - 具体的な数値見込み
   - 短期・長期効果の区別

**合計文字数: 約5,000〜8,000文字**

---

## 6. データマッピング一覧

### Phase 1 → 企業概要

| 質問ID | 質問内容 | 様式2での使用箇所 |
|--------|---------|----------------|
| Q1-0 | 店舗名・住所（Google Maps） | 事業者情報 |
| Q1-1 | 業種 | 事業の概要 |
| Q1-2 | 代表者名 | 事業者情報 |
| Q1-3 | 提供商品・サービス | 主要サービス |
| Q1-4 | 従業員数 | 業務状況 |
| Q1-5 | 開業年月 | 創業年 |
| Q1-13 | 決算月 | 事業者情報 |
| Q1-14 | 直近期の売上 | 財務データ表 |
| Q1-15 | 直近期の利益 | 財務データ表 |
| Q1-16〜Q1-19 | 過去3期分の財務データ | 財務データ表 |
| Q1-20 | 粗利率 | 経営状況 |
| Q1-21 | 客単価 | 経営状況 |

### Phase 2 → 顧客ニーズと市場の動向

| 質問ID | 質問内容 | 様式2での使用箇所 |
|--------|---------|----------------|
| P2-1 | ターゲット顧客 | ターゲット顧客層の明確化 |
| P2-2 | 選ばれる理由 | 顧客評価 |
| P2-3 | 顧客ニーズ | 顧客ニーズの分析 |
| P2-4 | ニーズの変化 | 市場環境の変化 |
| P2-5 | 市場トレンド | 市場全体の動向 |
| P2-6 | 競合比較 | 競合分析 |

### Phase 3 → 自社の強み

| 質問ID | 質問内容 | 様式2での使用箇所 |
|--------|---------|----------------|
| P3-1 | 独自性・差別化 | 競合他社と比較した優位性 |
| P3-2 | 顧客への価値 | 顧客に評価されている点 |
| P3-3 | 専門性・資格 | 品質・技術の強み |
| P3-4 | 設備・技術 | 設備・ノウハウの強み |
| P3-5 | 実績・評価 | 実績、口コミ評価 |
| P3-6 | 課題・弱み | 課題（対比として） |
| P3-7 | 立地・商圏 | 立地の特性 |

### Phase 4 → 経営方針・目標と今後のプラン

| 質問ID | 質問内容 | 様式2での使用箇所 |
|--------|---------|----------------|
| P4-1 | 今後の目標 | 経営方針・目標 |
| P4-2 | 目標達成の計画 | 具体的プラン |
| P4-3 | 売上目標 | 数値目標 |
| P4-4 | 重点施策 | 具体的行動 |
| P4-5 | 実施時期 | プランの時期 |
| P4-6 | 長期ビジョン | 長期的プラン |
| P4-7 | 経営課題 | 現状の課題認識 |
| P4-8 | 活用する強み | 強みの活用方法 |

### Phase 5 → 補助事業計画

| 質問ID | 質問内容 | 様式2での使用箇所 |
|--------|---------|----------------|
| P5-1 | 補助金の使い道 | 事業名、取組内容 |
| P5-2 | 購入予定設備 | 取組の実施方法 |
| P5-3 | 実施スケジュール | 実施時期 |
| P5-4 | 期待される効果 | 補助事業の効果 |
| P5-5〜P5-12 | 詳細な計画 | 取組内容の詳細、効果の根拠 |

---

## 7. 改善点のまとめ

### Before（修正前）
- ❌ 古い質問ID（Q2-0, Q2-2等）を参照 → データが空欄
- ❌ Phase 2-5のデータを使用せず → 収集した情報が無駄
- ❌ 簡易的なプロンプト → 低品質な申請書
- ❌ 文体の指示が弱い → です・ます調が混在
- ❌ CLAUDE.md要件と不一致 → 審査に通りにくい

### After（修正後）
- ✅ 最新の質問ID（Q1-0〜Q1-21, P2-1〜P5-12）を使用
- ✅ Phase 1-5の全54質問のデータを活用
- ✅ CLAUDE.md準拠の詳細なプロンプト
- ✅ 「である調（常体）」の徹底指示
- ✅ 様式2の構成・記載内容が要件に完全一致

---

## 8. 期待される効果

### 申請書の質の向上
1. **データの網羅性**: 全54質問のデータが反映される
2. **審査員への訴求力**: CLAUDE.mdの要件に完全準拠
3. **文体の統一**: である調で統一された読みやすい文章
4. **数値の具体性**: 過去3期分の財務データ、客単価等が明記
5. **説得力**: 顧客分析・強み・目標が論理的に展開

### 審査通過率の向上
- ❌ 修正前: データ不足・低品質 → 審査通過率 低
- ✅ 修正後: データ充実・高品質 → 審査通過率 向上見込み

---

## 9. 次のステップ

### 完了したタスク
- [x] buildApplicationPrompt関数の完全書き直し
- [x] Phase 1-5全データの活用
- [x] CLAUDE.md準拠の構造化

### 残りのタスク
- [ ] Phase 6（文章スタイルの確認）の実装
  - 年代・性別に応じた文章スタイルの適用
  - 「堅実型」「情熱型」「親しみやすさ型」等の選択
- [ ] 実際のテストデータで様式2生成を実行
- [ ] 生成された様式2の品質確認
- [ ] 必要に応じてプロンプトの微調整

---

## 10. テスト方法

### 手動テスト手順

1. **Phase 1-5の質問に回答**
   - 全54質問に回答（テストデータ使用可）

2. **申請書を生成**
   - 「申請書を生成」ボタンをクリック
   - 生成完了を待つ（30秒〜1分程度）

3. **生成内容の確認**
   - 様式2の構成が正しいか確認
   - である調（常体）で統一されているか確認
   - 過去3期分の財務データ表があるか確認
   - Phase 2-5のデータが反映されているか確認

4. **ダウンロード**
   - マークダウン形式でダウンロード
   - Word等で開いて最終確認

### 期待される出力

```markdown
# 小規模事業者持続化補助金 申請書（様式2）

## 【経営計画】

### 1. 企業概要

当店は2021年3月に開業したイタリアンレストランである...

| 項目 | 3期前 | 2期前 | 直近期 |
|------|------|------|--------|
| 売上高 | 1,200万円 | 1,350万円 | 1,440万円 |
| 経常利益 | 100万円 | 130万円 | 150万円 |

...

### 2. 顧客ニーズと市場の動向

当店の主なターゲット顧客は、30-50代の女性グループである...

...
```

---

## 11. 関連ドキュメント

- [CLAUDE.md](../CLAUDE.md) - 様式2の全要件定義
- [全質問リスト_模範解答付き.md](./全質問リスト_模範解答付き.md) - 全54質問の一覧
- [業種別回答例システム_実装完了.md](./業種別回答例システム_実装完了.md) - 業種別例文システム
- [業種別回答例と創作ガイドライン.md](./業種別回答例と創作ガイドライン.md) - 創作ルール

---

## 12. 実装完了確認

- [x] Phase 1-5の全質問IDを正しく取得
- [x] プロンプトに全データを組み込み
- [x] CLAUDE.md準拠の出力フォーマット指定
- [x] 「である調（常体）」の徹底指示
- [x] 必須要素（財務データ表、具体的数値等）の明示
- [x] ドキュメント作成

**修正完了日:** 2025年10月23日

**次のステップ:** 実際のテストデータで様式2生成を実行し、品質を確認
