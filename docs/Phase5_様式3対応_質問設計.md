# Phase 5質問設計 - 様式3（経費明細表・資金調達方法）対応版

**作成日**: 2025-11-16
**目的**: 様式3（経費明細表・資金調達方法）を自動生成するために必要な情報を収集

---

## 1. 様式3に必要な情報

### 1.1 経費明細表（Ⅱ）

| 項目 | 内容 | 収集方法 |
|-----|------|---------|
| **経費区分** | ①〜⑪の11種類 | 選択式質問で収集 |
| **内容・必要理由** | 何のために必要か | テキスト入力で収集 |
| **経費内訳** | 単価×回数 | 構造化入力で収集 |
| **税込・税抜** | 税込/税抜を明示 | 選択式で収集 |
| **補助対象経費** | 金額（円） | 自動計算 |

### 1.2 計算項目

| 項目 | 計算式 | 自動計算 |
|-----|--------|---------|
| (1) 補助対象経費小計（ウェブサイト除く） | ③以外の合計 | ✅ |
| (2) 補助金交付申請額（ウェブサイト除く） | (1) × 2/3 または 3/4 | ✅ |
| (3) ウェブサイト関連費小計 | ③の合計 | ✅ |
| (4) ウェブサイト関連費交付申請額 | (3) × 2/3、ただし(6)×1/4が上限 | ✅ |
| (5) 補助対象経費合計 | (1) + (3) | ✅ |
| (6) 補助金交付申請額合計 | (2) + (4) | ✅ |

### 1.3 資金調達方法（Ⅲ）

| 項目 | 計算式 | 自動計算 |
|-----|--------|---------|
| 自己資金 | (5) - (6) | ✅ |
| 持続化補助金 | (6) | ✅ |
| 合計額 | (5) | ✅ |
| 補助金相当額の手当（自己資金） | (6) | ✅ |

---

## 2. 経費区分（11種類）

| 区分 | 名称 | 具体例 |
|-----|------|--------|
| ① | 機械装置等費 | POSレジ、厨房機器、製造装置 |
| ② | 広報費 | チラシ、ポスター、新聞広告、SNS広告 |
| ③ | ウェブサイト関連費 | HP制作、ECサイト構築、SEO対策 |
| ④ | 展示会等出展費 | ブース出展料、装飾費 |
| ⑤ | 旅費 | 市場調査、販路開拓のための旅費 |
| ⑥ | 開発費 | 試作品開発、新商品開発 |
| ⑦ | 資料購入費 | 市場調査資料、専門書 |
| ⑧ | 雑役務費 | 通訳、翻訳、デザイン制作 |
| ⑨ | 借料 | 会場借料、機器レンタル料 |
| ⑩ | 設備処分費 | 既存設備の撤去費用 |
| ⑪ | 委託・外注費 | コンサル費用、HP制作委託 |

---

## 3. 新しいPhase 5質問フロー

### 3.1 質問の構成（全10問）

| 質問ID | 質問内容 | タイプ | 様式3への活用 |
|--------|---------|--------|-------------|
| P5-1 | 補助事業で行う事業名（30文字以内） | text | 様式2 - 補助事業名 |
| P5-2 | 購入・導入するもの（項目のリスト） | textarea | 経費明細表 - 項目リスト |
| **P5-3** | **各項目の経費区分（①〜⑪）** | dynamic | 経費明細表 - 経費区分 |
| **P5-4** | **各項目の費用内訳（単価×回数）** | dynamic | 経費明細表 - 経費内訳 |
| **P5-5** | **各項目の税込・税抜** | dynamic | 経費明細表 - 税込/税抜 |
| P5-6 | 実施時期（開始） | text | 様式2 - 開始時期 |
| P5-7 | 実施時期（完了） | text | 様式2 - 完了時期 |
| P5-8 | 新規顧客数の見込み | number | 様式2 - 効果 |
| P5-9 | リピート率の見込み | number | 様式2 - 効果 |
| P5-10 | 補助金が必要な理由 | single_select | 様式2 - 必要性 |

### 3.2 動的質問の仕組み（P5-3, P5-4, P5-5）

P5-2で入力された項目ごとに、以下の情報を収集する：

**例：P5-2の回答**
```
・POSレジシステム
・ホームページ制作
・チラシ印刷
・看板制作
```

**↓ 自動的に4つの項目について、それぞれP5-3, P5-4, P5-5を聞く**

#### P5-3: 経費区分の選択

**質問文**:
「【POSレジシステム】はどの経費区分に該当しますか？」

**選択肢**:
- ① 機械装置等費
- ② 広報費
- ③ ウェブサイト関連費
- ④ 展示会等出展費
- ⑤ 旅費
- ⑥ 開発費
- ⑦ 資料購入費
- ⑧ 雑役務費
- ⑨ 借料
- ⑩ 設備処分費
- ⑪ 委託・外注費

**helpText**:
「💡 一般的には『①機械装置等費』が該当します」

#### P5-4: 費用内訳（単価×回数）

**質問文**:
「【POSレジシステム】の費用を教えてください。」

**入力形式** (2つのフィールド):
- 単価: 300,000円
- 数量: 1台

**helpText**:
「💡 『単価×数量』の形式で入力してください（例：300,000円 × 1台）」

#### P5-5: 税込・税抜

**質問文**:
「【POSレジシステム】の費用は税込ですか？税抜ですか？」

**選択肢**:
- 税込
- 税抜

---

## 4. データ構造の設計

### 4.1 Firestoreに保存するデータ構造

```javascript
answers: {
  'P5-1': '新規顧客獲得のための地域広報及びオンラインショップサイトのリニューアル事業',

  'P5-2': [
    'POSレジシステム',
    'ホームページ制作',
    'チラシ印刷',
    '看板制作'
  ],

  'P5-3': {
    'POSレジシステム': '①機械装置等費',
    'ホームページ制作': '③ウェブサイト関連費',
    'チラシ印刷': '②広報費',
    '看板制作': '②広報費'
  },

  'P5-4': {
    'POSレジシステム': {
      unitPrice: 300000,
      quantity: 1,
      unit: '台',
      breakdown: '300,000円×1台'
    },
    'ホームページ制作': {
      unitPrice: 500000,
      quantity: 1,
      unit: '式',
      breakdown: '500,000円×1式'
    },
    'チラシ印刷': {
      unitPrice: 50000,
      quantity: 2,
      unit: '回',
      breakdown: '50,000円×2回'
    },
    '看板制作': {
      unitPrice: 150000,
      quantity: 1,
      unit: '個',
      breakdown: '150,000円×1個'
    }
  },

  'P5-5': {
    'POSレジシステム': '税込',
    'ホームページ制作': '税込',
    'チラシ印刷': '税込',
    '看板制作': '税込'
  },

  'P5-6': '2025年6月',
  'P5-7': '2025年12月',
  'P5-8': 20, // 新規顧客数（組/人）
  'P5-9': 30, // リピート率（%）
  'P5-10': '自己資金だけでは投資が難しい'
}
```

---

## 5. 様式3自動生成ロジック

### 5.1 経費明細表の生成

```javascript
function generateExpenseBreakdown(answers) {
  const items = answers['P5-2']; // 項目リスト
  const categories = answers['P5-3']; // 経費区分
  const costs = answers['P5-4']; // 費用内訳
  const taxTypes = answers['P5-5']; // 税込・税抜

  const expenses = items.map(item => ({
    category: categories[item],
    description: item,
    breakdown: costs[item].breakdown,
    taxType: taxTypes[item],
    amount: costs[item].unitPrice * costs[item].quantity
  }));

  return expenses;
}
```

### 5.2 補助金額の自動計算

```javascript
function calculateSubsidy(expenses, isDeficitBusiness = false) {
  // 補助率: 赤字事業者は3/4、それ以外は2/3
  const rate = isDeficitBusiness ? 3/4 : 2/3;

  // ウェブサイト関連費とそれ以外を分離
  const webExpenses = expenses.filter(e => e.category === '③ウェブサイト関連費');
  const otherExpenses = expenses.filter(e => e.category !== '③ウェブサイト関連費');

  // (1) 補助対象経費小計（ウェブサイト除く）
  const calc1 = otherExpenses.reduce((sum, e) => sum + e.amount, 0);

  // (2) 補助金交付申請額（ウェブサイト除く）
  const calc2 = Math.floor(calc1 * rate);

  // (3) ウェブサイト関連費に係る補助対象経費小計
  const calc3 = webExpenses.reduce((sum, e) => sum + e.amount, 0);

  // (6) 補助金交付申請額合計（仮計算）
  const calc6_temp = calc2 + Math.floor(calc3 * rate);

  // (4) ウェブサイト関連費に係る交付申請額（(6)の1/4が上限）
  const calc4 = Math.min(Math.floor(calc3 * rate), Math.floor(calc6_temp * 0.25));

  // (5) 補助対象経費合計
  const calc5 = calc1 + calc3;

  // (6) 補助金交付申請額合計（確定）
  const calc6 = calc2 + calc4;

  return {
    calc1, // 補助対象経費小計（ウェブサイト除く）
    calc2, // 補助金交付申請額（ウェブサイト除く）
    calc3, // ウェブサイト関連費小計
    calc4, // ウェブサイト関連費交付申請額
    calc5, // 補助対象経費合計
    calc6  // 補助金交付申請額合計
  };
}
```

### 5.3 資金調達方法の生成

```javascript
function generateFundingPlan(calc5, calc6) {
  const selfFunding = calc5 - calc6; // 自己資金

  return {
    expenseFunding: {
      selfFunding: selfFunding,
      subsidy: calc6,
      total: calc5
    },
    subsidyFunding: {
      selfFunding: calc6, // 補助金入金までは自己資金で賄う
      bankLoan: 0,
      other: 0
    }
  };
}
```

---

## 6. バリデーション

### 6.1 必須チェック

- [ ] (1) + (3) = (5) が一致
- [ ] (2) + (4) = (6) が一致
- [ ] (4) ≤ (6) × 1/4 を満たす
- [ ] ウェブサイト関連費が全体の1/4以内
- [ ] 補助金額が上限以内（通常枠50万円、賃上げ枠200万円等）

### 6.2 エラーメッセージ

```javascript
// ウェブサイト関連費が1/4を超える場合
if (calc4 > calc6 * 0.25) {
  throw new Error('ウェブサイト関連費が全体の補助金額の1/4を超えています。ウェブサイト関連費を減額するか、他の経費を増やしてください。');
}

// 補助金額が上限を超える場合
const subsidyLimit = getSubsidyLimit(applicationFrame); // 通常枠50万円等
if (calc6 > subsidyLimit) {
  throw new Error(`補助金額が上限（${subsidyLimit.toLocaleString()}円）を超えています。経費を見直してください。`);
}
```

---

## 7. 実装スケジュール

### フェーズ1: Phase 5質問の修正（1日）
- [ ] conversationalQuestionsPhase5.jsを修正
- [ ] P5-2の回答をパースして項目リストを取得
- [ ] P5-3, P5-4, P5-5の動的質問を実装

### フェーズ2: 様式3生成ロジックの実装（1日）
- [ ] functions/index.jsにgenerateForm3関数を追加
- [ ] 経費明細表の生成ロジック
- [ ] 補助金額の自動計算ロジック
- [ ] 資金調達方法の生成ロジック

### フェーズ3: 様式2との統合（0.5日）
- [ ] generateSubsidyApplication関数を修正
- [ ] 様式2-①（経営計画）+ 様式2-②（経費明細表・資金調達方法）を統合出力

### フェーズ4: テストと検証（0.5日）
- [ ] 10店舗分のテストデータで様式3を生成
- [ ] 参考資料（r3i_kisairei_coffee.pdf）との比較
- [ ] バリデーションのテスト

**合計**: 約3日

---

## 8. 期待される効果

| 項目 | 現在 | 実装後 | 改善幅 |
|-----|------|--------|--------|
| 様式2完成度 | 57.5% | 82.5% | **+25%** |
| 申請書としての完全性 | 不完全 | 完全 | **✅** |
| ユーザーの入力負担 | 中 | 低 | **減少** |
| 自動計算の精度 | - | 100% | **新規** |

---

**次のアクション**:
1. conversationalQuestionsPhase5.jsの修正
2. ChatContainer.jsxでの動的質問処理の実装
3. Cloud Functions（generateForm3）の実装

---

**作成者**: Claude Code
**更新日**: 2025-11-16
